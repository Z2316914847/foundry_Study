理解无常损失

1、如何计算池子中的代币数量 和 池子中代币价格

2、计算普通持有 和 流动性提供者 和 无常损失

3、无常损失定义

4、池子中两个代币价格变化才会导致无常损失

5、产生无常损失，项目方怎么弥补用户损失呢？

6、无常损失的其他知识

### 一、如何计算池子中代币价格 和 代币数量

#### 计算池子中代币数量

- AMM自动化做市商必须遵守：K = X * Y
- 计算池子中代币价格：假设池子中有 A - B两种代币( ETH -USDT)，A和B两种代币价格计算如下:
  - Pa = B / A
  - Pb = A / B
- 计算池子中代币数量：
  - A = B / Pa：其实我们是不知道 池子中代币的数量的，所以还要简化
    -  A * A= （A*B） / ( A * Pa) = K / (A * Pa) ，所以 A = sqrt ( K / Pa )
  - B = A * Pa：
    - B * B = A * B * Pa = K * Pa ,所以 B = sqrt ( K * Pa )

### 二、计算普通持有 和 流动性提供者 和 无常损失

假设一个ETH/USDC资金池。1 ETH = 400 USDT。你决定投入 ​**1 ETH**​（A） 和 ​**400 USDT**（B） 成为流动性提供者（LP）。

- 此时，池子总共有 **100 ETH** 和 **400,00 USDT*。你的份额是 **1%**。
- 恒定乘积 `k = 100 * 40000 = 4000000`。

#### 计算普通持有 ( ETH上涨600 )

1 * 600 + 400 = 1000 USDT。

普通持有并不会参数无常损失

#### 流动性提供者( ETH上涨100% )

- 池子中两个代币数量
  - 上涨后 池子中 ETH 数量 = sqrt ( 100 * 40000/ 600 ) = 81.6497 E
  - 池子中 USDT 数量 = sqrt ( 100 * 40000 * 600) = 48989.7946
- 你的资产 ( USDT ) ：
  - ETH资产：81.6497 * 0.01 * 600 = 489.8982 USDT
  - USDT资产： 48989.7946 * 0.01 = 489.897946 USDT
  - ETH上涨后 你的总资产 = 489.8982 + 489.897946 = 979.796146 USDT

### 无常损失

无常损失 = 1000 - 979.796146 = 20.203854 USDT

### 三、无常损失定义

**无偿损失**是指，当你将两种加密资产存入自动化做市商（AMM）资金池（如Uniswap、Sushiswap）提供流动性后，与你简单地将这些资产拿在手里（HODL）相比，所可能发生的**价值差额**。

关键点：

1. **“无偿”**：这种损失并非源于任何人窃取你的资金或协议出错。它是资产价格比率变化导致的**机会成本**。
2. **“非永久”**：如果资产的价格比率**重新回到**你存入时的比率，这种损失就会消失。这就是它被称为“非永久”的原因。但一旦你撤出流动性，损失就变成了**永久性的**。
3. **无常损失是针对 流动性提供者，对普通用户没有影响。**

### 四、池子中两个代币价格变化才会导致无常损失

### 五、产生无常损失，项目方怎么弥补用户损失呢？

- 添加交易交易手续费功能，用户在交易时，收取 0.03% 的交易手续费

### 六、无偿损失的其他知识

1. **价格波动越大，损失越大**：两种资产的价格比率变化越剧烈，无偿损失就越大。如果价格完全不变，则无偿损失为零。
2. **对称性**：无论价格涨跌，只要比率变了，就会产生损失。ETH涨到4000或跌到1000，都会产生类似幅度的无偿损失。
3. **与涨跌方向无关**：只与**价格变化的幅度**有关。价格变为原来的4倍（4x）或变为原来的1/4（0.25x），产生的无偿损失是相同的。

下图直观地展示了价格变化与无偿损失的关系：

```
| Price Change | Impermanent Loss |
|--------------|------------------|
| ±0%          | 0.0%             |
| ±10%         | ~0.1%            |
| ±25%         | ~0.6%            |
| ±50%         | ~2.0%            |
| ±75%         | ~5.1%            |
| ±100%        | ~5.7%            | (价格翻倍或腰斩)
| ±200%        | ~13.4%           | (价格变为3倍或1/3)
| ±400%        | ~25.5%           | (价格变为5倍或1/5)
| ±900%        | ~38.5%           | (价格变为10倍或1/10) 
```

4. 添加流动性时，一定要选择那种波动性小的池子 或者 将流动性区间设置一定范围，一争取手续费为主。
   - 场景1：稳定币对（如USDC/USDT）：价格波动极小，无偿损失可忽略不计，主要赚取手续费。
   - 场景2：**你对两种资产的未来价格走势看法一致**（即认为它们的汇率会保持稳定），美元和人民币汇率。
   - 场景3：你相信交易费用的收入将远高于潜在的无偿损失**。**
   - 注意：在决定成为LP之前，一定要使用无偿损失计算器（网上很多）模拟各种价格 scenario，充分理解你正在承担的风险。