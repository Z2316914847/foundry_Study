# 钱包开发

## 1、如何创建钱包

#### 钱包的功能

- 管理账户：创建账户、私钥、助记词、keystores、Mpc管理
- 构造交易、签名交易、发送交易
- 其他：资产展示、交易记录

#### 钱包的创建

- 账户创建
  - 账户本质就是一个32字节的随机数
  - 私钥根据 secp256kl椭圆曲线算法 计算出公钥：y^2 = x^3+7(mod p)：
    - 未压缩公钥 = 私钥 * 椭圆曲线上一个固定的点（0x04 + x坐标 + y坐标）
    - 哈希公钥 = keccak256( 未压缩公钥 )
    - 地址 = 0x哈希公钥后20字节 

注意：私钥本来就难记。然后钱包就是管理私钥的，然后有些人注重隐私，他的一个钱包就会有多个私钥、然后用户就很难记住折磨多私钥。所以后来就诞生BIP32-》BIP44-》BIP39

- BIP32： 根据 **一个随机数种子** 通过分层确定性推导 的方式得到n个私钥，这样保存的时候，只需要 **保存一个种子就可以**，私钥可以 推导出来。采用这种方式的钱包也称HD钱包。
- BIP44：给BIP32的路赋予意义来支持做多币种、多地址
- BIP39：由于私钥难记，又推出 助记词

#### BIP32 分层确定性推导逻辑

![1760053735043](C:\Users\28448\AppData\Roaming\Typora\typora-user-images\1760053735043.png)

分层确定性推到的过程，第二步推导子子私钥的过程![1760056965725](C:\Users\28448\AppData\Roaming\Typora\typora-user-images\1760056965725.png)

- 主私钥推到过程：
  - 通过密码学 生成安全的伪随机数（也就是所谓的种子：这个种子有这三种情况：128、256、512位）
  - 第二步：选择 HMAC-SHA512函数，种子 作为参数，就能得到 一个主私钥 和 一个主链编码
- 子私钥推到过程（有两个方式）
  - 第一种方式（强化衍生方案，索引大于(2^32)-1）：选择 HMAC-SHA512函数，父私钥 +主链编码 + 索引 作为参数，就能得到 一个子私钥 和 一个子链编码。
  - 第二种方式（强化衍生方案，索引小于2^32）：选择 HMAC-SHA512函数，父公钥 +主链编码 + 索引 作为参数，就能得到 一个子私钥 和 一个子链编码。

#### BIP44

- 通过这种分层（树状结构）推导出来的秘钥，通常用路径来表示，每个级别之间用斜杠 / 来表示，由主私钥衍生出的私钥起始以“m”打头。因此，第一个母密钥生成的子私钥是m/0。第一个公共钥匙是M/0。第一个子密钥的子密钥就是m/0/1，以此类推。

- BIP44则是为这个路径约定了一个规范的含义(也扩展了对多币种的支持)，BIP0044指定了包含5个预定义树状层级的结构：

  ```
  m / purpose' / coin' / account' / change / address_index
  1、m是固定的, Purpose也是固定的，值为44（或者 0x8000002C）
  2、这个代表的是币种，0代表比特币，1代表比特币测试链，60代表以太坊
  完整的币种列表地址：https://github.com/satoshilabs/slips/blob/master/slip-0044.md
  3、代表这个币的账户索引，从0开始
  4、Change
  常量0用于外部(收款地址)，常量1用于内部（也称为找零地址）。外部用于在钱包外可见的地址（例如，用于接收付款）。
  5、address_index
  这就是地址索引，从0开始，代表生成第几个地址，官方建议，每个account下的address_index不要超过20
  ```

- 一句话概括下BIP44就是：**给BIP32的分层路径定义规范**

#### BIP39

- 使用助记词的方式 来 **生成种子**。这样用户只需要记住12（或24）个单词，单词序列通过 PBKDF2 与 HMAC-SHA512 函数创建出随机种子作为 BIP32 的种子。
- 如何生成助记词
  - 132位随机数 = 随机生成128位随机数 + 随机数做校验的 4位
  - 将132位切成12份，每份11位，每份去差BIP39定义的单词表，这样就得到了12个助记词
- 助记词生成种子
  - 选择密钥拉伸函数，助记词和盐值作为参数，就能得到一个 种子
  - 注意：拉伸函数被用来增强密钥安全性，PBKDF2 与 HMAC-SHA512就是常用的密钥拉伸函数，
  - 密钥拉伸函数逻辑：通过一个随机函数，然后助记词和盐值作为参数，然后重复运算最终产生一个更长的（512位）密钥种子，然后通过种子产生私钥。

## 2、私钥加密 KeyStore文件

有些人有一种需求：能不能将私钥 以 另外一种更安全的形式存在，**答案是有的，将私钥加密到 KeyStores文件中**。

#### 生成KeySrores文件原理

- 用户输入密码（你可以这样理解：这个密码是打开KeyStores文件的钥匙）

- 使用 Scrypt 算法 函数，密码作为参数，生成一个加密密钥A。

- 用 加密密钥 和 使用 AES-128-CTR函数加密 私钥，这样就得到Keystores文件。

- 然后将keyStore文件保存起来。

  ![1760061000048](C:\Users\28448\AppData\Roaming\Typora\typora-user-images\1760061000048.png)

## 3、MPC私钥分片

- 将利用MOC技术将私钥分片，每个分片有不同的参与方保管，通过m/n个分片聚合私钥(或签名)

  避免了

## 4、如何构造一个交易、签名交易、发送交易

#### 构造一个交易

- // 没有基础（不会编程） - 版本

  ```solidity
  {
      to：address                          // 交易接收者
      nonce：hex                           // 发送者的nonce
      type：hex                            // 交易类型：0（legcy），1（EIP2930），2（EIP1559）
      value：hex                           // 交易携带的ETN数量
      data：hex                            // 交易携带的数据
      maxPriorityFeePerGas：hex            // 小费
      MaxFeePerGas：hex                    // 愿意制度最大的费用
      gas：hex                             // 21000 固定值
  }
  ```

- // 有基础（会编程） - 版本 - viem - 基础

  ![1760316935254](C:\Users\28448\AppData\Roaming\Typora\typora-user-images\1760316935254.png)

#### 签名交易

- 消息签名
- 消息经过hash后签名（相较于直接对消息签名，hash后签名更更更安全）

## 5、去中心化钱包和中心化钱包、硬件钱包、合约钱包、多签钱包

钱包看自己选择把，





